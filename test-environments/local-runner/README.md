# OpenSearch Curator - Local Testing Guide
# =========================================

This directory contains practical examples for testing OpenSearch Curator
manually, outside of the automated pytest suite.

## Prerequisites

1. **OpenSearch running via the compose stack**
   ```powershell
   docker-compose -f test-environments/compose/docker-compose.test.yml up -d
   ```
   > This stack expects certificates generated by `scripts/generate_test_certs.py`
   > and listens on `https://localhost:19200`.

2. **Curator installed**
   ```powershell
   # From repository root
   pip install -e .
   ```

3. **Test data (optional)**
   ```powershell
   # Create sample indices - see create-test-data.ps1
   .\create-test-data.ps1
   ```

## Configuration Files

- **curator.yml** - Main configuration
  - Points to https://localhost:19200
  - 30s request timeout
  - SSL verification disabled (for local testing)

## Action Files

All action files have `disable_action: True` by default for safety.

### 01-list-all-indices.yml
**Purpose:** List all indices (safe dry-run)
**Filters:** None - lists everything
**Risk Level:** ðŸŸ¢ Safe (disable_action: True)

```powershell
curator --config curator.yml 01-list-all-indices.yml --dry-run
```

### 02-delete-old-test-indices.yml
**Purpose:** Delete test indices older than 7 days
**Filters:** 
  - Pattern: test-*
  - Age: >7 days
**Risk Level:** ðŸ”´ **DELETES DATA** when disable_action: False

```powershell
# Dry-run first!
curator --config curator.yml 02-delete-old-test-indices.yml --dry-run

# Actual execution (be careful!)
# Edit file and set disable_action: False, then:
curator --config curator.yml 02-delete-old-test-indices.yml
```

### 03-create-snapshot.yml
**Purpose:** Snapshot logs-* indices to backup repository
**Filters:**
  - Pattern: logs-*
  - Age: >1 day
**Risk Level:** ðŸŸ¡ Requires repository setup
**Prerequisites:**
  - Create repository first: `opensearch_repo_mgr --config curator.yml create fs --name backup --location /tmp/backup`

```powershell
# Dry-run
curator --config curator.yml 03-create-snapshot.yml --dry-run
```

### 04-close-old-indices.yml
**Purpose:** Close indices older than 30 days (saves resources)
**Filters:**
  - Pattern: logs-*
  - Age: >30 days
**Risk Level:** ðŸŸ¡ Indices become read-only but recoverable

```powershell
curator --config curator.yml 04-close-old-indices.yml --dry-run
```

### 05-force-merge.yml
**Purpose:** Merge segments to optimize storage
**Filters:**
  - Pattern: logs-*
  - Age: >14 days
  - Exclude: Already merged indices
**Risk Level:** ðŸŸ¡ Resource intensive, takes time

```powershell
curator --config curator.yml 05-force-merge.yml --dry-run
```

### 06-reduce-replicas.yml
**Purpose:** Set replicas to 0 for old indices (saves disk)
**Filters:**
  - Pattern: logs-*
  - Age: >60 days
**Risk Level:** ðŸŸ¡ Reduces data redundancy

```powershell
curator --config curator.yml 06-reduce-replicas.yml --dry-run
```

### 07-convert-to-remote-safe.yml
**Purpose:** Convert indices to remote-backed storage (keeps originals)
**Filters:**
  - Pattern: test-*
  - Age: >3 days
**Risk Level:** ðŸŸ¢ Safe - keeps original indices
**Prerequisites:**
  - Repository configured: `opensearch_repo_mgr --config curator.yml create fs --name backup --location /tmp/backup`
  - OpenSearch cluster with remote store configured

```powershell
curator --config curator.yml 07-convert-to-remote-safe.yml --dry-run
```

### 08-convert-to-remote-delete.yml
**Purpose:** Convert to remote storage AND delete local originals
**Filters:**
  - Pattern: test-*
  - Age: >7 days
**Risk Level:** ðŸ”´ **DELETES ORIGINALS** after conversion
**Prerequisites:** Same as 07, plus verify remote indices work first!

```powershell
# Dry-run first!
curator --config curator.yml 08-convert-to-remote-delete.yml --dry-run
```

### 09-convert-existing-snapshot.yml
**Purpose:** Convert using existing snapshot (no new snapshot)
**Filters:**
  - Pattern: logs-*
  - Age: >1 day
**Risk Level:** ðŸŸ¡ Requires existing snapshot
**Prerequisites:** Snapshot 'logs-snapshot-20251124' must exist

```powershell
curator --config curator.yml 09-convert-existing-snapshot.yml --dry-run
```

### 10-convert-custom-alias.yml
**Purpose:** Convert with custom alias names
**Filters:**
  - Action 1: Single index (test-2025.11.01)
  - Action 2: Multiple indices (test-* oldest 5)
**Risk Level:** ðŸŸ¡ Requires understanding of alias behavior
**Prerequisites:** Repository configured

```powershell
curator --config curator.yml 10-convert-custom-alias.yml --dry-run
```

## Testing Workflow

### Step 1: Create Test Data

```powershell
# See create-test-data.ps1 for script to create sample indices
.\create-test-data.ps1

# Verify indices created
curl https://localhost:19200/_cat/indices?v
```

### Step 2: Run Dry-Runs

Always test with `--dry-run` first:

```powershell
# List what would happen
curator --config curator.yml 01-list-all-indices.yml --dry-run
```

### Step 3: Review Output

Check the logs for:
- âœ… Indices matched by filters
- âœ… Actions that would be performed
- âŒ Any errors or warnings

### Step 4: Execute (Carefully!)

If dry-run looks good:

```powershell
# Edit action file - set disable_action: False
# Then run without --dry-run
curator --config curator.yml 02-delete-old-test-indices.yml
```

### Step 5: Verify Results

```powershell
# Check indices after action
curl https://localhost:19200/_cat/indices?v

# Check cluster health
curl https://localhost:19200/_cluster/health?pretty
```

## Common Commands

### List all indices
```powershell
curl https://localhost:19200/_cat/indices?v
```

### Check index details
```powershell
curl https://localhost:19200/test-index?pretty
```

### Check cluster health
```powershell
curl https://localhost:19200/_cluster/health?pretty
```

### Check repository
```powershell
curl https://localhost:19200/_snapshot?pretty
```

### Create repository (filesystem)
```powershell
opensearch_repo_mgr --config curator.yml create fs --name backup --location /tmp/backup
```

### List snapshots
```powershell
curl https://localhost:19200/_snapshot/backup/_all?pretty
```

## Safety Tips

1. **Always use --dry-run first**
   ```powershell
   curator --config curator.yml action.yml --dry-run
   ```

2. **Keep disable_action: True in files**
   - Only change to False when you're 100% sure
   - Edit the file, run, then change back

3. **Test with test-* indices first**
   - Never test on production data
   - Create disposable test indices

4. **Backup important data**
   - Create snapshots before destructive operations
   - Verify snapshots work before deleting data

5. **Use small unit_count values**
   - Test with age > 1 day instead of > 90 days
   - Easier to verify results

6. **Check cluster health**
   - Before: `curl https://localhost:19200/_cluster/health`
   - After: Verify still green/yellow

## Troubleshooting

### Connection refused
```
Error: [Errno 111] Connection refused
```
**Solution:** Start OpenSearch on port 19200

### Repository not found
```
RepositoryMissingException: [backup] missing
```
**Solution:** Create repository first with opensearch_repo_mgr

### No indices matched
```
INFO Action ID: 1, "delete_indices" completed with no changes.
```
**Solution:** Check your filters - may be too restrictive

### Timeout errors
```
Error: Request timeout
```
**Solution:** Increase request_timeout in curator.yml

## Next Steps

1. âœ… Read this README
2. âœ… Start OpenSearch on port 19200
3. âœ… Run create-test-data.ps1 to create sample indices
4. âœ… Test 01-list-all-indices.yml with --dry-run
5. âœ… Modify an action file for your use case
6. âœ… Run with --dry-run, verify output
7. âœ… Set disable_action: False and execute

## Reference

- **Curator Docs:** https://opensearch.org/docs/latest/tools/curator/
- **Filter Types:** https://github.com/opensearch-project/opensearch-curator/tree/main/docs/reference/filters.md
- **Action Types:** https://github.com/opensearch-project/opensearch-curator/tree/main/docs/reference/actions.md
- **YAML Config:** https://github.com/opensearch-project/opensearch-curator/tree/main/docs/reference/configfile.md
