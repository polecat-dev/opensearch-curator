name: Integration Matrix

on:
  workflow_dispatch:
    inputs:
      run-legacy:
        description: 'Also run the OpenSearch 2.11.1 job'
        required: false
        default: 'false'
  schedule:
    - cron: '0 5 * * 1' # Mondays at 05:00 UTC
  push:
    tags:
      - 'v*.*.*'

jobs:
  latest:
    name: Latest OpenSearch (3.3.0)
    runs-on: ubuntu-latest
    env:
      PYTHON_VERSION: '3.11'
      TEST_ES_SERVER: http://localhost:9200
      TEST_S3_BUCKET: curator-test-bucket
      TEST_S3_ENDPOINT: http://localhost:4566
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
    services:
      opensearch:
        image: opensearchproject/opensearch:3.3.0
        env:
          discovery.type: single-node
          DISABLE_SECURITY_PLUGIN: true
          OPENSEARCH_JAVA_OPTS: '-Xms1g -Xmx1g'
          path.repo: /tmp
        ports:
          - 9200:9200
        options: >-
          --health-cmd "curl -f http://localhost:9200/_cluster/health || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 20

      localstack:
        image: localstack/localstack:latest
        env:
          SERVICES: s3
          DEFAULT_REGION: us-east-1
        ports:
          - 4566:4566
        options: >-
          --health-cmd "awslocal s3 ls || exit 0"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pytest pytest-cov boto3

      - name: Wait for OpenSearch
        run: |
          for i in {1..60}; do
            if curl -s http://localhost:9200/_cluster/health | grep -q '"status":"green"'; then
              echo "OpenSearch is ready"
              break
            fi
            echo "Waiting for OpenSearch... ($i/60)"
            sleep 5
          done
          curl -s http://localhost:9200/_cluster/health | jq

      - name: Verify OpenSearch path.repo
        run: |
          echo "Checking path.repo configuration..."
          curl -s http://localhost:9200/_nodes/settings | jq '.nodes[].settings.path.repo'

      - name: Run integration tests
        run: pytest tests/integration/ -v --tb=short --maxfail=5

      - name: Run coverage (latest OpenSearch)
        run: pytest tests/integration/ --cov=curator --cov-report=xml --cov-report=term -v

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: integration-latest
          name: opensearch-3.3.0
          fail_ci_if_error: false

  legacy:
    name: Legacy OpenSearch (2.11.1)
    if: >
      github.event_name != 'workflow_dispatch' ||
      (github.event_name == 'workflow_dispatch' && inputs.run-legacy == 'true')
    runs-on: ubuntu-latest
    env:
      PYTHON_VERSION: '3.11'
      TEST_ES_SERVER: http://localhost:9200
      TEST_S3_BUCKET: curator-test-bucket
      TEST_S3_ENDPOINT: http://localhost:4566
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
    services:
      opensearch:
        image: opensearchproject/opensearch:2.11.1
        env:
          discovery.type: single-node
          DISABLE_SECURITY_PLUGIN: true
          OPENSEARCH_JAVA_OPTS: '-Xms1g -Xmx1g'
          path.repo: /tmp
        ports:
          - 9200:9200
        options: >-
          --health-cmd "curl -f http://localhost:9200/_cluster/health || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 20

      localstack:
        image: localstack/localstack:latest
        env:
          SERVICES: s3
          DEFAULT_REGION: us-east-1
        ports:
          - 4566:4566
        options: >-
          --health-cmd "awslocal s3 ls || exit 0"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pytest boto3

      - name: Wait for OpenSearch
        run: |
          for i in {1..60}; do
            if curl -s http://localhost:9200/_cluster/health | grep -q '"status":"green"'; then
              echo "OpenSearch is ready"
              break
            fi
            echo "Waiting for OpenSearch... ($i/60)"
            sleep 5
          done
          curl -s http://localhost:9200/_cluster/health | jq

      - name: Verify OpenSearch path.repo
        run: |
          echo "Checking path.repo configuration..."
          curl -s http://localhost:9200/_nodes/settings | jq '.nodes[].settings.path.repo'

      - name: Run integration tests (legacy)
        run: pytest tests/integration/ -v --tb=short --maxfail=5

  integration-summary:
    runs-on: ubuntu-latest
    needs: [latest, legacy]
    if: always()
    steps:
      - name: Integration Summary
        run: |
          echo "## Integration Matrix Summary" >> $GITHUB_STEP_SUMMARY
          echo "Latest OpenSearch job completed: ${{ needs.latest.result }}" >> $GITHUB_STEP_SUMMARY
          echo "Legacy OpenSearch job completed: ${{ needs.legacy.result }}" >> $GITHUB_STEP_SUMMARY
