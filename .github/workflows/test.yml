name: Integration Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']
        opensearch-version: ['2.11.1', '3.0.0', '3.1.0', '3.2.0']
    
    services:
      opensearch:
        image: opensearchproject/opensearch:${{ matrix.opensearch-version }}
        env:
          discovery.type: single-node
          DISABLE_SECURITY_PLUGIN: true
          OPENSEARCH_JAVA_OPTS: '-Xms512m -Xmx512m'
          path.repo: /tmp
        ports:
          - 9200:9200
        options: >-
          --health-cmd "curl -f http://localhost:9200/_cluster/health || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
      
      localstack:
        image: localstack/localstack:latest
        env:
          SERVICES: s3
          DEFAULT_REGION: us-east-1
        ports:
          - 4566:4566
        options: >-
          --health-cmd "awslocal s3 ls || exit 0"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install pytest pytest-cov boto3
    
    - name: Wait for OpenSearch
      run: |
        for i in {1..30}; do
          if curl -s http://localhost:9200/_cluster/health | grep -q '"status":"green"'; then
            echo "OpenSearch is ready"
            break
          fi
          echo "Waiting for OpenSearch... ($i/30)"
          sleep 2
        done
        curl -s http://localhost:9200/_cluster/health | jq
    
    - name: Verify OpenSearch path.repo
      run: |
        echo "Checking path.repo configuration..."
        curl -s http://localhost:9200/_nodes/settings | jq '.nodes[].settings.path.repo'
    
    - name: Run integration tests
      env:
        TEST_ES_SERVER: http://localhost:9200
        TEST_S3_BUCKET: curator-test-bucket
        TEST_S3_ENDPOINT: http://localhost:4566
        AWS_ACCESS_KEY_ID: test
        AWS_SECRET_ACCESS_KEY: test
      run: |
        pytest tests/integration/ -v --tb=short --maxfail=5
    
    - name: Run tests with coverage
      if: matrix.python-version == '3.12' && matrix.opensearch-version == '3.2.0'
      env:
        TEST_ES_SERVER: http://localhost:9200
        TEST_S3_BUCKET: curator-test-bucket
        TEST_S3_ENDPOINT: http://localhost:4566
        AWS_ACCESS_KEY_ID: test
        AWS_SECRET_ACCESS_KEY: test
      run: |
        pytest tests/integration/ --cov=curator --cov-report=xml --cov-report=term -v
    
    - name: Upload coverage to Codecov
      if: matrix.python-version == '3.12' && matrix.opensearch-version == '3.2.0'
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: integration
        name: py${{ matrix.python-version }}-opensearch${{ matrix.opensearch-version }}
        fail_ci_if_error: false

  test-summary:
    runs-on: ubuntu-latest
    needs: test
    if: always()
    steps:
      - name: Test Summary
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Integration tests completed across all Python and OpenSearch versions" >> $GITHUB_STEP_SUMMARY
